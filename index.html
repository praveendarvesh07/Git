<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transition Plan Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for the pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script type="module">
        // Supabase Imports
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = 'https://tlnfqepjzstgnydxnylp.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsbmZxZXBqenN0Z255ZHhueWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NDk0OTAsImV4cCI6MjA3OTIyNTQ5MH0.j64hQXEExQjzX6DcM8YSw1SYehvbj2TV6cvaJLfhjn8'; 
        
        // --- GLOBAL SETUP ---
        const TABLE_ADDITIONAL = 'additional_tasks';
        let supabase = null;
        const userId = crypto.randomUUID(); 
        
        const AVAILABLE_USERS = ['Hanno', 'Tom', 'Prashant'];
        
        // Initialize calendar state to the start of the plan (Nov 2025)
        let currentCalendarDate = new Date(2025, 10, 24); 
        
        // Sample Data transcribed from the uploaded image, now with new naming convention
        const transitionData = [
            { week: 'Week of Nov 24th', startDate: '11/24/2025', endDate: '11/28/2025', effectiveDays: 5, saPct: 0.90, saHours: 36, partnerPct: 0.10, partnerHours: 4, tasks: 'DSA: Working on custom asset creation and AE enablement. PSM: Review partner content, data and internal team meetings.', notes: '' },
            { week: 'Week of Dec 1st', startDate: '12/1/2025', endDate: '12/5/2025', effectiveDays: 5, saPct: 0.80, saHours: 32, partnerPct: 0.20, partnerHours: 8, tasks: 'DSA: Custom assets, AI Initiatives, Opportunity related work. PSM: Review partner content, partner meetings and internal team calls and introductions.', notes: '' },
            { week: 'Week of Dec 8th', startDate: '12/8/2025', endDate: '12/12/2025', effectiveDays: 5, saPct: 0.70, saHours: 28, partnerPct: 0.30, partnerHours: 12, tasks: 'DSA: AE interaction, support with opportunities, AI Initiatives. PSM: Schedule calls with respective partner team members, introductions and learnings.', notes: '' },
            // UPDATED PSM TASK FOR WEEK OF DEC 15TH
            { week: 'Week of Dec 15th', startDate: '12/15/2025', endDate: '12/19/2025', effectiveDays: 5, saPct: 0.60, saHours: 24, partnerPct: 0.40, partnerHours: 16, tasks: 'DSA: Custom assets, reusable asset support, internal team support, AE interaction and tasks. PSM: Schedule calls with internal team members, create PSM assets for partner meetings, build content repository.', notes: '' },
            { week: 'Week of Dec 22nd', startDate: '12/22/2025', endDate: '12/26/2025', effectiveDays: 3, saPct: 0.50, saHours: 12, partnerPct: 0.50, partnerHours: 12, tasks: 'DSA: Internal team interaction, AI initiatives. PSM: Partner interaction, meetings and support.', notes: 'Public Holidays Dec 25th' },
            { week: 'Week of Dec 29th', startDate: '12/29/2025', endDate: '1/2/2026', effectiveDays: 0, saPct: 0.40, saHours: 12.8, partnerPct: 0.60, partnerHours: 19.2, tasks: 'DSA: Limited availability. PSM: Limited availability.', notes: 'Planned leaves' },
            { week: 'Week of Jan 5th', startDate: '1/5/2026', endDate: '1/9/2026', effectiveDays: 5, saPct: 0.30, saHours: 12, partnerPct: 0.70, partnerHours: 28, tasks: 'DSA: Custom asset and reusable asset support. PSM: internal and partner team meetings and support.', notes: '' },
            { week: 'Week of Jan 12th', startDate: '1/12/2026', endDate: '1/16/2026', effectiveDays: 5, saPct: 0.20, saHours: 8, partnerPct: 0.80, partnerHours: 32, tasks: 'DSA: Handover planning, team interaction, AE interaction, custom asset. PSM: Internal and partner team meetings and support.', notes: '' },
            { week: 'Week of Jan 19th', startDate: '1/19/2026', endDate: '1/23/2026', effectiveDays: 5, saPct: 0.10, saHours: 4, partnerPct: 0.90, partnerHours: 36, tasks: 'DSA: Final handover and internal team interaction. PSM: Final handover and internal team interaction.', notes: '' },
        ];

        // --- UTILITY FUNCTIONS ---
        function formatPercent(value) {
            return (value * 100).toFixed(0) + '%';
        }

        function showLoading() {
             document.getElementById('dashboard-content').innerHTML = `
                <div class="flex justify-center items-center h-full p-10 bg-white rounded-xl shadow-lg">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
                        <p class="text-lg text-gray-600">Loading Transition Data...</p>
                    </div>
                </div>
            `;
        }
        
        /**
         * Parses the task string (e.g., "DSA: task. PSM: task.") into separate, formatted HTML blocks.
         * Labels updated to full names.
         */
        function parseTasks(taskString) {
            const parts = { DSA: '', PSM: '' };
            let currentKey = '';
            
            // Split the string based on "DSA:" or "PSM:"
            const segments = taskString.split(/(DSA:|PSM:)/).filter(s => s.trim() !== '');

            for (let i = 0; i < segments.length; i++) {
                const segment = segments[i].trim();
                if (segment === 'DSA:') {
                    currentKey = 'DSA';
                } else if (segment === 'PSM:') {
                    currentKey = 'PSM';
                } else if (currentKey) {
                    // Append the task description to the current key
                    parts[currentKey] += segment.trim();
                    currentKey = ''; // Reset key after description is processed
                }
            }
            
            let html = '';

            // Render DSA tasks - Updated label
            if (parts.DSA && parts.DSA.toLowerCase() !== 'none') {
                html += `
                    <div class="mt-2 p-2 rounded-lg bg-indigo-50 border-l-4 border-indigo-400">
                        <span class="font-semibold text-indigo-700">Digital Solution Advisory:</span>
                        <p class="text-sm text-indigo-600">${parts.DSA}</p>
                    </div>
                `;
            } else if (parts.DSA.toLowerCase() === 'none') {
                 html += `
                    <div class="mt-2 p-2 rounded-lg bg-indigo-50 border-l-4 border-indigo-400">
                        <span class="font-semibold text-indigo-700">Digital Solution Advisory:</span>
                        <p class="text-sm text-indigo-600">None Specified.</p>
                    </div>
                `;
            }

            // Render PSM tasks - Updated label
            if (parts.PSM && parts.PSM.toLowerCase() !== 'none') {
                 html += `
                    <div class="mt-2 p-2 rounded-lg bg-teal-50 border-l-4 border-teal-400">
                        <span class="font-semibold text-teal-700">Partner Success Management:</span>
                        <p class="text-sm text-teal-600">${parts.PSM}</p>
                    </div>
                `;
            } else if (parts.PSM.toLowerCase() === 'none') {
                 html += `
                    <div class="mt-2 p-2 rounded-lg bg-teal-50 border-l-4 border-teal-400">
                        <span class="font-semibold text-teal-700">Partner Success Management:</span>
                        <p class="text-sm text-teal-600">None Specified.</p>
                    </div>
                `;
            }

            return html;
        }

        // Custom error rendering function for table creation guidance
        function renderSupabaseSetupError() {
            document.getElementById('dashboard-content').innerHTML = `
                <div class="p-8 text-center text-red-700 bg-red-100 rounded-xl shadow-lg mt-8">
                    <p class="font-bold text-xl">Supabase Setup Required</p>
                    <p class="mt-4 text-sm">The required table (<code class="font-mono bg-red-200 p-1 rounded">${TABLE_ADDITIONAL}</code>) could not be found or accessed.</p>
                    
                    <div class="mt-6 p-4 bg-white border border-red-300 rounded-lg text-left">
                        <p class="font-semibold text-base mb-2 text-gray-800">Action Required: Verify Tables</p>
                        <p class="text-sm text-gray-700 mb-2">Only the <code class="font-mono bg-red-200 p-1 rounded">additional_tasks</code> table is strictly required. Please ensure it is created and Row Level Security (RLS) policies are set up. You can run this block of SQL in your Supabase SQL editor:</p>
                        
                        <div>
                            <p class="font-mono bg-gray-200 p-2 rounded text-sm font-semibold">1. additional_tasks (for Hanno, Tom, Prashant's input)</p>
                            <pre class="bg-gray-800 text-green-300 p-3 rounded-lg overflow-x-auto text-xs font-mono whitespace-pre-wrap mt-1">
CREATE TABLE public.additional_tasks (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    week text NOT NULL,
    added_by text NOT NULL,
    task_description text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
ALTER TABLE public.additional_tasks ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow all authenticated users to read and write additional tasks" ON public.additional_tasks FOR ALL USING (true);
                            </pre>
                        </div>
                        <p class="text-xs text-red-500 mt-4">After successfully running the SQL, refresh the dashboard.</p>
                    </div>
                </div>
            `;
        }

        // --- CALENDAR & SCROLLING LOGIC ---

        window.changeMonth = (delta) => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Boundary check: Limit to Nov 2025 (Month 10) to Jan 2026 (Month 0 in 2026)
            if (year < 2025 || (year === 2025 && month < 10)) {
                currentCalendarDate = new Date(2025, 10, 1); // Reset to Nov 2025
            } else if (year > 2026 || (year === 2026 && month > 0)) {
                 currentCalendarDate = new Date(2026, 0, 1); // Reset to Jan 2026
            }

            renderCalendar();
        };
        
        window.scrollToWeek = (dateStr) => {
            const selectedDate = new Date(dateStr);
            // Normalize time to noon to avoid timezone issues during comparison
            selectedDate.setHours(12, 0, 0, 0); 

            const weekMatch = transitionData.find(w => {
                const start = new Date(w.startDate);
                const end = new Date(w.endDate);
                start.setHours(12, 0, 0, 0);
                end.setHours(12, 0, 0, 0);
                
                return selectedDate >= start && selectedDate <= end;
            });

            if (weekMatch) {
                // Create a URL-friendly ID for the target card
                const targetId = weekMatch.week.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                const targetElement = document.getElementById(targetId);
                
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Briefly highlight the card
                    targetElement.classList.add('ring-4', 'ring-yellow-400', 'ring-offset-2', 'transition-all', 'duration-500');
                    setTimeout(() => {
                        targetElement.classList.remove('ring-4', 'ring-yellow-400', 'ring-offset-2');
                    }, 1500);
                } else {
                    console.warn(`Could not find element for week: ${weekMatch.week}`);
                }
            } else {
                 // Show a temporary message if the date is not part of the plan
                 const status = document.getElementById('status-message');
                 if (status) {
                    status.innerHTML = `<div class="p-2 text-sm text-yellow-700 bg-yellow-100 rounded-md">Date selected is not part of the defined transition plan weeks.</div>`;
                    setTimeout(() => status.innerHTML = '', 3000);
                 }
            }
        };

        function renderCalendar() {
            const calendarContainer = document.getElementById('calendar-container-content');
            if (calendarContainer) {
                calendarContainer.innerHTML = generateCalendarHTML(
                    currentCalendarDate.getFullYear(), 
                    currentCalendarDate.getMonth()
                );
            }
        }

        // Function to generate the HTML for the calendar month
        function generateCalendarHTML(year, monthIndex) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date

            const firstDayOfMonth = new Date(year, monthIndex, 1);
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const monthName = firstDayOfMonth.toLocaleString('default', { month: 'long' });

            let calendarDaysHtml = '';
            
            // Calculate padding for Monday start (0=Sun, 1=Mon, ..., 6=Sat)
            let dayOfWeek = firstDayOfMonth.getDay(); 
            // If Sunday (0), padding is 6 days. Otherwise, it's dayOfWeek - 1.
            let paddingDays = dayOfWeek === 0 ? 6 : dayOfWeek - 1; 

            for (let i = 0; i < paddingDays; i++) {
                calendarDaysHtml += `<div class="p-1 text-center text-xs"></div>`;
            }

            // Loop through all days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, monthIndex, day);
                date.setHours(12, 0, 0, 0); // Normalize time
                const dateStr = date.toISOString().split('T')[0];
                const isToday = date.toDateString() === new Date().toDateString(); // Check against current day

                let bgColor = 'bg-white hover:bg-gray-100';
                let borderColor = 'border-transparent';
                
                // Check if the date falls within any transition week (for visual highlighting)
                let weekMatch = transitionData.find(w => {
                    const start = new Date(w.startDate);
                    const end = new Date(w.endDate);
                    start.setHours(12, 0, 0, 0);
                    end.setHours(12, 0, 0, 0);

                    return date >= start && date <= end;
                });

                if (weekMatch) {
                    bgColor = 'bg-indigo-100 hover:bg-indigo-200 cursor-pointer text-indigo-800 font-bold';
                    borderColor = 'border-indigo-400';
                }

                if (isToday) {
                    borderColor = (weekMatch) ? 'border-4 border-yellow-500' : 'border-2 border-yellow-500';
                }
                
                // Add the day button/cell
                calendarDaysHtml += `
                    <button onclick="scrollToWeek('${dateStr}')" 
                            class="h-7 p-1 text-center text-xs font-semibold rounded-lg transition-colors ${bgColor} border ${borderColor} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            aria-label="Go to week for ${monthName} ${day}">
                        ${day}
                    </button>
                `;
            }

            return `
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="p-1 text-gray-600 hover:text-gray-900 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h3 id="calendar-month-year" class="font-bold text-lg text-gray-800">${monthName} ${year}</h3>
                    <button onclick="changeMonth(1)" class="p-1 text-gray-600 hover:text-gray-900 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-7 text-xs font-medium text-gray-500 mb-2">
                    <div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div><div>Su</div>
                </div>
                <div class="grid grid-cols-7 gap-1">
                    ${calendarDaysHtml}
                </div>
            `;
        }

        // --- SUPABASE SETUP ---

        async function initSupabase() {
            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                document.getElementById('user-id-display').textContent = `Session ID: ${userId}`;
                
                showLoading();

                // Start listening for data once the client is ready
                listenForTaskStatus();
            } catch (error) {
                console.error("Supabase Initialization Error:", error);
                // General catch for key/URL issues
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="p-8 text-center text-red-600 bg-red-100 rounded-xl shadow-lg mt-8">
                        <p class="font-bold">Error Connecting to Supabase</p>
                        <p class="mt-2 text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        // --- SUPABASE DATA OPERATIONS ---

        /**
         * Fetches all necessary data (additional tasks) 
         * and sets up real-time listeners.
         */
        async function listenForTaskStatus() {
            if (!supabase) return;

            // 1. Initial Data Fetch 
            await fetchAndRender();

            // 2. Setup Real-time Subscription for additional task changes
            supabase.channel('additional-task-updates')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: TABLE_ADDITIONAL
                }, fetchAndRender)
                .subscribe();
        }
        
        /**
         * Fetches the latest additional tasks, then re-renders.
         */
        async function fetchAndRender(payload = null) {
            let additionalTasks = [];

            // Fetch Additional Tasks
            const { data: additionalData, error: additionalError } = await supabase
                .from(TABLE_ADDITIONAL)
                .select('id, week, added_by, task_description');
            
            if (additionalError) {
                 // Check for the "table not found" error code
                 if (additionalError.code === "PGRST205") {
                     renderSupabaseSetupError();
                     return;
                }
                console.error("Supabase additional tasks fetch error:", additionalError);
                // Render the dashboard with empty tasks if another error occurred
                renderDashboard(additionalTasks);
            } else {
                additionalTasks = additionalData;
                renderDashboard(additionalTasks);
            }
        }

        /**
         * Submits a new additional task to the database.
         */
        window.submitAdditionalTask = async (event) => {
            event.preventDefault();
            const form = event.target;
            const week = form.week.value;
            const added_by = form.added_by.value;
            const task_description = form.task_description.value.trim();

            if (!task_description) {
                document.getElementById('status-message').innerHTML = `<div class="p-2 text-sm text-yellow-700 bg-yellow-100 rounded-md">Task description cannot be empty.</div>`;
                setTimeout(() => document.getElementById('status-message').innerHTML = '', 3000);
                return;
            }

            const loadingMessage = document.getElementById('add-task-loading');
            loadingMessage.classList.remove('hidden');

            try {
                const { error } = await supabase
                    .from(TABLE_ADDITIONAL)
                    .insert({ 
                        week: week, 
                        added_by: added_by, 
                        task_description: task_description 
                    });

                loadingMessage.classList.add('hidden');
                if (error) throw error;
                
                // Explicitly call fetchAndRender to ensure the UI updates immediately after adding a task.
                fetchAndRender(); 

                document.getElementById('status-message').innerHTML = `<div class="p-2 text-sm text-green-700 bg-green-100 rounded-md">Task assigned successfully!</div>`;
                setTimeout(() => document.getElementById('status-message').innerHTML = '', 3000);
                form.reset();
            } catch (e) {
                loadingMessage.classList.add('hidden');
                console.error("Error adding additional task:", e);
                document.getElementById('status-message').innerHTML = `<div class="p-2 text-sm text-red-700 bg-red-100 rounded-md">Error assigning task. Check console.</div>`;
                setTimeout(() => document.getElementById('status-message').innerHTML = '', 3000);
            }
        };

        /**
         * Deletes a user-added task by its ID.
         */
        window.deleteAdditionalTask = async (taskId) => {
            if (!supabase) { 
                console.error("Supabase client not initialized."); 
                document.getElementById('status-message').innerHTML = `<div class="p-2 text-sm text-red-700 bg-red-100 rounded-md">Cannot delete: Supabase not initialized.</div>`;
                setTimeout(() => document.getElementById('status-message').innerHTML = '', 3000);
                return; 
            }
            
            // NOTE: Using window.confirm() as a temporary measure instead of custom modal UI
            if (!window.confirm("Are you sure you want to delete this task?")) {
                return;
            }

            // Provide immediate feedback
            document.getElementById('status-message').innerHTML = `<div class="p-2 text-sm text-gray-700 bg-gray-100 rounded-md">Deleting task...</div>`;

            try {
                console.log(`Attempting to delete task ID: ${taskId}`);
                const { error } = await supabase
                    .from(TABLE_ADDITIONAL)
                    .delete()
                    .eq('id', taskId);

                if (error) throw error;
                
                // Explicitly call fetchAndRender to ensure the UI updates immediately after deletion.
                fetchAndRender(); 
                
                console.log(`Task ID ${taskId} deleted successfully.`);
                document.getElementById('status-message').innerHTML = `<div class="p-2 text-sm text-yellow-700 bg-yellow-100 rounded-md">Task deleted.</div>`;
                setTimeout(() => document.getElementById('status-message').innerHTML = '', 3000);
            } catch (e) {
                console.error(`Error deleting task ID ${taskId}:`, e);
                document.getElementById('status-message').innerHTML = `<div class="p-2 text-sm text-red-700 bg-red-100 rounded-md">Error deleting task. Check console for details.</div>`;
                setTimeout(() => document.getElementById('status-message').innerHTML = '', 5000);
            }
        };


        // --- CHART RENDERING (New Weekly Charts) ---

        /**
         * Renders the individual SA vs Partner doughnut chart for each week in the table.
         * Labels updated to full names.
         */
        function drawWeeklyCharts() {
            // Destroy existing charts to prevent duplication issues
            Chart.helpers.each(Chart.instances, function(instance){
                instance.destroy();
            });

            transitionData.forEach(data => {
                // Generate unique ID based on the week name
                const canvasId = `chart-${data.week.replace(/[^a-zA-Z0-9]/g, '')}`;
                const ctx = document.getElementById(canvasId);

                if (ctx) {
                    const saPct = data.saPct;
                    const partnerPct = data.partnerPct;
                    
                    // Display percentage in the middle of the doughnut (using Chart.js plugin structure)
                    const centerTextPlugin = {
                        id: 'centerText',
                        beforeDraw: (chart) => {
                            const { width, height, ctx } = chart;
                            ctx.restore();
                            // Adjust font size dynamically
                            const fontSize = (height / 80).toFixed(2);
                            ctx.font = `${fontSize}em sans-serif`;
                            ctx.textBaseline = 'middle';

                            const text = `${(partnerPct * 100).toFixed(0)}%`; // Show Partner % in center
                            const textX = Math.round((width - ctx.measureText(text).width) / 2);
                            const textY = height / 2;

                            ctx.fillStyle = '#111827'; // Tailwind gray-900
                            ctx.fillText(text, textX, textY);
                            ctx.save();
                        }
                    };

                    new Chart(ctx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Digital Solution Advisory', 'Partner Success Management'], // UPDATED LABELS
                            datasets: [{
                                // Data passed as absolute percentages (0-100)
                                data: [saPct * 100, partnerPct * 100], 
                                backgroundColor: [
                                    '#F87171', // Red-400 for SA
                                    '#2563EB'  // Blue-600 for Partner
                                ],
                                borderWidth: 0,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '80%',
                            plugins: {
                                legend: { display: false },
                                centerText: centerTextPlugin, // Use the custom plugin
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            // Format the value back to 0-100%
                                            const value = context.parsed.toFixed(0) + '%'; 
                                            return label + ': ' + value;
                                        }
                                    }
                                }
                            },
                        },
                        plugins: [centerTextPlugin]
                    });
                }
            });
        }

        function renderCalendarAndForm() {
            return `
                <div class="col-span-full grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <!-- Calendar Section -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 min-h-[300px]">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Plan Calendar View</h3>
                        <div id="calendar-container-content">
                            <!-- Calendar is rendered here by renderCalendar() -->
                        </div>
                    </div>
                    
                    <!-- Assign Task Form -->
                    ${renderAddTaskForm()}
                </div>
            `;
        }


        function renderAddTaskForm() {
            const options = AVAILABLE_USERS.map(user => `<option value="${user}">${user}</option>`).join('');

            return `
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Assign Additional Task</h3>
                    <form onsubmit="submitAdditionalTask(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="task-week" class="block text-sm font-medium text-gray-700">Select Week</label>
                                <select id="task-week" name="week" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                    ${transitionData.map(d => `<option value="${d.week}">${d.week}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="added-by" class="block text-sm font-medium text-gray-700">Your Name</label>
                                <select id="added-by" name="added_by" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                    ${options}
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="task-description" class="block text-sm font-medium text-gray-700">Task Description</label>
                                <textarea id="task-description" name="task_description" rows="3" required class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 p-2"></textarea>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                                Assign Task
                            </button>
                            <span id="add-task-loading" class="text-sm text-indigo-600 hidden">Saving...</span>
                        </div>
                        <div id="status-message"></div>
                    </form>
                </div>
            `;
        }
        
        function renderWeeklyCards(additionalTasks, currentWeekIndex) {
            const groupedAdditionalTasks = additionalTasks.reduce((acc, task) => {
                if (!acc[task.week]) acc[task.week] = [];
                acc[task.week].push(task);
                return acc;
            }, {});

            const cards = transitionData.map((data, index) => {
                const isCurrent = index === currentWeekIndex;
                const cardBorderColor = isCurrent ? 'border-yellow-500' : 'border-gray-200';
                const headerBg = isCurrent ? 'bg-yellow-100' : 'bg-gray-50';
                const weekChartId = `chart-${data.week.replace(/[^a-zA-Z0-9]/g, '')}`;
                const targetId = data.week.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase(); // ID for scrolling

                const additionalTasksForWeek = groupedAdditionalTasks[data.week] || [];
                const additionalTasksHtml = additionalTasksForWeek.map(task => `
                    <li class="mt-2 text-xs text-gray-700 bg-indigo-50/50 p-2 rounded-lg border-l-2 border-indigo-400 flex justify-between items-start">
                        <span class="flex-grow">
                            <span class="font-semibold text-indigo-700 block text-sm">${task.added_by}</span>: ${task.task_description}
                        </span>
                        <button onclick="deleteAdditionalTask('${task.id}')" 
                                class="ml-2 text-red-500 hover:text-red-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-500 rounded-full p-1"
                                aria-label="Delete task">
                            <!-- SVG Trash Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.723-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </li>
                `).join('');

                return `
                    <div id="${targetId}" class="bg-white rounded-xl shadow-lg border-t-4 ${cardBorderColor} overflow-hidden transform hover:shadow-xl transition duration-300">
                        
                        <!-- Card Header & Status -->
                        <div class="${headerBg} p-4 flex justify-between items-center">
                            <h4 class="text-xl font-bold text-gray-900">${data.week}</h4>
                        </div>

                        <div class="p-4 grid grid-cols-2 gap-4">
                            <!-- Split Chart -->
                            <div class="col-span-1 flex flex-col justify-center items-center">
                                <div class="h-24 w-24">
                                    <canvas id="${weekChartId}"></canvas>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Digital Solution Advisory vs Partner Success Management Split</p>
                            </div>

                            <!-- Metrics - Updated Labels -->
                            <div class="col-span-1 space-y-2">
                                <div class="p-2 bg-red-50 rounded-lg text-sm">
                                    <span class="font-semibold text-red-700">Digital Solution Advisory:</span> ${formatPercent(data.saPct)} (${data.saHours} hrs)
                                </div>
                                <div class="p-2 bg-blue-50 rounded-lg text-sm">
                                    <span class="font-semibold text-blue-700">Partner Success Management:</span> ${formatPercent(data.partnerPct)} (${data.partnerHours} hrs)
                                </div>
                                <div class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-100">
                                    Dates: ${data.startDate} - ${data.endDate}
                                    <br>
                                    Eff. Days: ${data.effectiveDays}
                                </div>
                            </div>
                        </div>

                        <!-- Tasks Section -->
                        <div class="p-4 border-t border-gray-100">
                            <h5 class="text-sm font-semibold text-gray-800 mb-2">Primary Tasks:</h5>
                            ${parseTasks(data.tasks)}
                            
                            <!-- Additional Tasks -->
                            ${additionalTasksForWeek.length > 0 ? `
                                <h5 class="text-sm font-semibold text-indigo-700 mt-4 mb-1">Assigned Tasks:</h5>
                                <ul class="list-none space-y-1">
                                    ${additionalTasksHtml}
                                </ul>
                            ` : ''}
                        </div>

                        <!-- Notes -->
                        ${data.notes ? `
                            <div class="p-4 bg-yellow-50 text-xs text-yellow-700 border-t border-gray-100">
                                <span class="font-bold">Note:</span> ${data.notes}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            return `
                <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8">Weekly Breakdown</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${cards}
                </div>
            `;
        }

        function renderDashboard(additionalTasks = []) {
            const container = document.getElementById('dashboard-content');
            if (!container) return;

            // 1. Calculate Summary Metrics
            const totalWeeks = transitionData.length;
            
            // Find the current week index 
            let currentWeekIndex = transitionData.findIndex(d => new Date(d.endDate) >= new Date());
            if (currentWeekIndex === -1) {
                currentWeekIndex = transitionData.length - 1;
            }

            // Calculate average enablement for the entire plan
            const totalPartnerPct = transitionData.reduce((sum, d) => sum + d.partnerPct, 0);
            const avgPartnerEnablement = totalWeeks > 0 ? totalPartnerPct / totalWeeks : 0;

            // 2. Generate Summary HTML 
            const summaryHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <p class="text-sm text-gray-500 font-medium">Total Weeks in Plan</p>
                        <p class="text-3xl font-bold text-gray-800 mt-1">${totalWeeks}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <p class="text-sm text-gray-500 font-medium">Avg. Partner Success Management</p>
                        <p class="text-3xl font-bold text-blue-600 mt-1">${formatPercent(avgPartnerEnablement)}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                        <p class="text-sm text-gray-500 font-medium">Current Week</p>
                        <p class="text-xl font-bold text-yellow-600 mt-2">${transitionData[currentWeekIndex].week}</p>
                        <p class="text-xs text-gray-400">${transitionData[currentWeekIndex].startDate} - ${transitionData[currentWeekIndex].endDate}</p>
                    </div>
                </div>
            `;

            // 3. Generate Calendar and Assign Task Form
            const calendarAndFormHTML = renderCalendarAndForm();

            // 4. Generate Detailed Cards
            const cardsHTML = renderWeeklyCards(additionalTasks, currentWeekIndex);

            // 5. Combine and display
            container.innerHTML = summaryHTML + calendarAndFormHTML + cardsHTML;

            // 6. Initial calendar render and Charts
            renderCalendar(); 
            drawWeeklyCharts(); 
        }

        // Initialize on load
        window.onload = initSupabase;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Focus styles for accessibility */
        input[type="checkbox"]:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); /* Indigo focus ring */
        }
        /* Custom styling for the SVG delete button to ensure it aligns properly */
        .items-start button {
            flex-shrink: 0;
            margin-top: 2px; /* Slight vertical adjustment */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 p-6 bg-white rounded-xl shadow-lg border-t-4 border-indigo-600">
            <h1 class="text-3xl font-extrabold text-gray-900">Praveen's Transition Plan</h1>
            <p class="text-gray-500 mt-1">Visual status tracking for partner enablement transition.</p>
            <p id="user-id-display" class="text-xs text-gray-400 mt-2">Session ID: Initializing...</p> 
        </header>

        <main id="dashboard-content" class="min-h-[400px]">
            <!-- Content will be rendered here by JavaScript -->
             <div class="flex justify-center items-center h-full p-10 bg-white rounded-xl shadow-lg">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
                    <p class="text-lg text-gray-600">Loading Transition Data...</p>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
